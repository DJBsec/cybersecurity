########################################################
### The following script uses the EPSS API to get    ###
### the EPSS Score and then output it with a         ###
### corresponding Color. for this script to run      ###
### you will need to make sure you have Colorama     ###
### installed in python.                             ###
########################################################


import requests
import json
from colorama import Fore, Style, init

# Initialize colorama
init(autoreset=True)

def fetch_epss_data(cve, date):
    """
    Fetch EPSS data from the API for a specific CVE and date.

    Parameters:
        cve (str): The CVE identifier (e.g., CVE-2022-26332).
        date (str): The date in YYYY-MM-DD format (e.g., 2022-03-05).

    Returns:
        dict: The JSON response from the API, or an error message.
    """
    url = f"https://api.first.org/data/v1/epss?envelope=true&pretty=true&cve={cve}&date={date}"
    
    try:
        response = requests.get(url)
        response.raise_for_status()  # Raise an HTTPError for bad responses (4xx or 5xx)
        return response.json()
    except requests.exceptions.RequestException as e:
        return {"error": str(e)}

def print_with_color(percentile):
    """
    Print the percentile with color coding based on its value.

    Parameters:
        percentile (float): The percentile value.
    """
    if 0 <= percentile < 30:
        print(f"{Fore.GREEN}Percentile: {percentile:.2f}%")
    elif 30 <= percentile < 75:
        print(f"{Fore.YELLOW}Percentile: {percentile:.2f}%")
    else:
        print(f"{Fore.RED}{Style.BRIGHT}Percentile: {percentile:.2f}%")

if __name__ == "__main__":
    # Get user input for CVE and date
    cve = input("Enter the CVE (e.g., CVE-2022-26332): ").strip()
    date = input("Enter the date (YYYY-MM-DD): ").strip()

    # Fetch data from the API
    result = fetch_epss_data(cve, date)

    # Extract and process the EPSS and Percentile values
    if "error" in result:
        print(f"Error: {result['error']}")
    else:
        try:
            data = result["data"][0]  # Access the first item in the 'data' list
            epss = float(data["epss"]) * 100  # Convert to a float and multiply by 100
            percentile = float(data["percentile"]) * 100  # Convert to a float and multiply by 100

            #print(f"EPSS: {epss:.2f}%")
            print_with_color(percentile)
        except (KeyError, IndexError, ValueError) as e:
            print(f"Error processing API response: {e}")
